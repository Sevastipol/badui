<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BL√ÖHAJ Soft toy, shark - IKEA</title>
<style>
  /* --- IKEA LEGITIMACY LAYER --- */
  body { font-family: 'Noto Sans', 'Roboto', Arial, sans-serif; background-color: #fff; margin: 0; color: #111; overflow-x: hidden; }
  header { padding: 20px 50px; border-bottom: 1px solid #e5e5e5; display: flex; align-items: center; justify-content: space-between; background: white; }
  .ikea-logo { background: #0058a3; color: #ffdb00; padding: 10px 15px; font-weight: 900; font-size: 24px; text-decoration: none; display: inline-block; }
  
  /* Shopping Cart Icon */
  .cart-icon-container { position: relative; cursor: pointer; }
  .cart-icon { width: 32px; height: 32px; display: block; }
  .cart-count { position: absolute; top: -8px; right: -8px; background: #d93025; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
  
  /* Notification Toast */
  .notification-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; align-items: center; pointer-events: none; }
  .notification { background: #0058a3; color: white; padding: 16px 24px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px; min-width: 300px; animation: slideDown 0.3s ease-out; pointer-events: auto; }
  @keyframes slideDown { from { transform: translateY(-100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .notification.fade-out { animation: fadeOut 0.3s ease-out forwards; }
  @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }
  .notification .check-icon { font-size: 24px; }
  
  /* Shopping Cart Sidebar */
  .cart-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 2400; }
  .cart-overlay.show { display: block; }
  .cart-sidebar { position: fixed; right: -420px; top: 0; width: 420px; height: 100%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.2); z-index: 2500; transition: right 0.3s ease; display: flex; flex-direction: column; }
  .cart-sidebar.open { right: 0; }
  .cart-header { padding: 24px; border-bottom: 1px solid #e5e5e5; display: flex; justify-content: space-between; align-items: center; }
  .cart-header h2 { margin: 0; font-size: 24px; }
  .close-cart { font-size: 28px; cursor: pointer; color: #888; line-height: 1; }
  .close-cart:hover { color: #111; }
  .cart-items { padding: 24px; overflow-y: auto; flex: 1; }
  .cart-item { display: flex; gap: 16px; padding: 16px; border-bottom: 1px solid #f0f0f0; align-items: center; }
  .cart-item img { width: 80px; height: 80px; object-fit: contain; }
  .cart-item-info { flex: 1; }
  .cart-item-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
  .cart-item-price { color: #484848; font-size: 14px; }
  .remove-item { background: #fff; border: 1px solid #ccc; padding: 6px 12px; cursor: pointer; font-size: 12px; }
  .remove-item:hover { background: #f0f0f0; }
  .cart-empty { text-align: center; padding: 60px 20px; color: #888; }
  .cart-footer { padding: 24px; border-top: 2px solid #e5e5e5; background: #fafafa; }
  .cart-subtotal { display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 16px; }
  .checkout-btn { background-color: #0058a3; color: white; border: none; padding: 16px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 50px; width: 100%; }
  .checkout-btn:hover { background-color: #004f93; }
  .checkout-btn:disabled { background-color: #ccc; cursor: not-allowed; }
  
  /* Payment Page */
  .payment-page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3500; overflow-y: auto; }
  .payment-container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
  .payment-header { text-align: center; margin-bottom: 40px; }
  .payment-header h1 { font-size: 32px; margin: 0; }
  .payment-section { background: #f9f9f9; padding: 30px; border-radius: 4px; margin-bottom: 30px; }
  .payment-section h2 { font-size: 20px; margin: 0 0 20px; color: #0058a3; }
  .order-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
  .order-item:last-child { border-bottom: none; }
  .fee-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
  .fee-row.total { font-size: 20px; font-weight: 700; border-top: 2px solid #0058a3; padding-top: 16px; margin-top: 16px; }
  .fee-row.subtotal { font-weight: 600; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
  .complete-payment-btn { background-color: #0058a3; color: white; border: none; padding: 20px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 50px; width: 100%; margin-top: 30px; }
  .complete-payment-btn:hover { background-color: #004f93; }
  
  .main-container { max-width: 1200px; margin: 40px auto; display: flex; gap: 60px; padding: 0 20px; }
  .product-image-section { flex: 1.5; text-align: center; }
  .product-image-section img.main-shark { width: 100%; max-width: 500px; }
  
  .placeholder-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 40px; padding-top: 20px; border-top: 2px dashed #eee; }
  .placeholder-item { background: #f9f9f9; height: 180px; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #eee; }
  .placeholder-item img { width: 100%; height: 100%; object-fit: cover; }

  .product-details { flex: 1; }
  .product-details h1 { font-size: 32px; margin: 0; font-weight: 700; }
  .product-details h2 { font-size: 16px; font-weight: 400; color: #484848; margin: 5px 0 20px; }
  .price { font-size: 28px; font-weight: 700; margin-bottom: 30px; }
  .price span { font-size: 14px; vertical-align: super; margin-right: 2px; }

  .buy-btn { background-color: #0058a3; color: white; border: none; padding: 20px 40px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 50px; width: 100%; transition: background-color 0.3s; }
  .buy-btn:hover { background-color: #004f93; }

  #oos-status { color: #d93025; font-size: 14px; margin-top: 15px; font-weight: bold; min-height: 20px; text-align: center; }
  .shark-desc { font-size: 14px; color: #444; line-height: 1.6; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }

  /* --- INTRUSIVE UPSELL UI --- */
  .upsell-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0); z-index: 3000; align-items: center; justify-content: center;
  }
  
  .upsell-card {
    background: white; width: 400px; height: 550px; padding: 30px; border-radius: 2px; text-align: center; position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box;
  }
  
  .close-upsell {
    position: absolute; top: 10px; right: 15px; font-size: 20px; color: #ccc; 
    cursor: pointer; font-family: Arial, sans-serif; line-height: 1; z-index: 10;
  }
  .close-upsell:hover { color: #111; }

  .upsell-card h3 { 
    margin: 0; font-size: 20px; color: #0058a3; min-height: 60px; display: flex; align-items: center; justify-content: center;
    user-select: none;
  }

  .upsell-card img { width: 100%; height: 220px; object-fit: contain; margin: 10px 0; user-select: none; -webkit-user-drag: none; }
  .upsell-card p { font-size: 14px; color: #444; margin-bottom: 20px; min-height: 40px; }
  .upsell-btns { display: flex; flex-direction: column; gap: 10px; margin-top: auto; }
  .add-to-cart-btn { background: #0058a3; color: white; border: none; padding: 15px; font-weight: bold; cursor: pointer; }

  /* --- CAPTCHA STYLES --- */
  #captcha-wrapper { display: none; flex-direction: column; align-items: center; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1.3); z-index: 1000; user-select: none; }
  #recaptcha-anchor-box { width: 300px; height: 74px; background: #fff; border: 1px solid #d3d3d3; border-radius: 3px; cursor: pointer; overflow: hidden; }
  #anchor-image { width: 100%; height: 100%; object-fit: contain; -webkit-user-drag: none; }
  #page-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
  #status-text { color: #d93025; font-size: 14px; margin-bottom: 8px; font-weight: 500; height: 18px; text-align: center; width: 380px; }
  .captcha-container { display: none; width: 380px; background: white; padding: 8px; box-shadow: 0 0 12px rgba(0,0,0,0.2); border: 1px solid #ccc; position: relative; }
  
  #loader-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
  .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #4A90E2; border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .header { background-color: #4A90E2; color: white; padding: 20px; margin-bottom: 4px; }
  .header h2 { margin: 0; font-size: 14px; font-weight: 400; }
  .header h1 { margin: 2px 0; font-size: 26px; font-weight: 900; }
  
  .grid-wrapper { width: 380px; height: 380px; overflow: hidden; position: relative; background: #ccc; }
  .grid { display: grid; grid-template-columns: repeat(3, 124px); grid-template-rows: repeat(3, 124px); gap: 4px; }
  .tile { width: 124px; height: 124px; position: relative; background: #eee; box-sizing: border-box; }
  .tile.selected { box-shadow: inset 0 0 0 6px #4A90E2; }

  .flying-bat { 
    position: absolute; width: 100px; height: 100px; z-index: 10; cursor: pointer; 
    animation: chaoticFly 3s infinite ease-in-out; 
    user-select: none; 
    -webkit-user-drag: none;
    -webkit-tap-highlight-color: transparent;
  }
  .ghost-decoy { 
    width: 100%; height: 100%; object-fit: cover; opacity: 0.5; cursor: pointer; 
    user-select: none; 
    -webkit-user-drag: none;
  }

  @keyframes chaoticFly { 0% { transform: translate(0, 0); } 25% { transform: translate(180px, -50px); } 50% { transform: translate(-100px, 150px); } 75% { transform: translate(200px, 200px); } 100% { transform: translate(0, 0); } }
  .footer { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-top: 1px solid #eee; margin-top: 5px;}
  .icons { color: #777; font-size: 22px; letter-spacing: 5px; }
  .verify-btn { background-color: #4A90E2; color: white; border: none; padding: 12px 24px; font-weight: bold; cursor: pointer; font-size: 14px; }
</style>
</head>
<body>

<header>
  <a href="#" class="ikea-logo">IKEA</a>
  <div class="cart-icon-container" onclick="toggleCart()">
    <img src="https://cdn-icons-png.flaticon.com/512/1413/1413908.png" class="cart-icon" alt="Cart">
    <span class="cart-count" id="cart-count">0</span>
  </div>
</header>

<div class="notification-container" id="notification-container"></div>

<div class="cart-overlay" id="cart-overlay" onclick="closeCart()"></div>

<div class="cart-sidebar" id="cart-sidebar">
  <div class="cart-header">
    <h2>Shopping Cart</h2>
    <span class="close-cart" onclick="closeCart()">√ó</span>
  </div>
  <div class="cart-items" id="cart-items">
    <div class="cart-empty">Your cart is empty</div>
  </div>
  <div class="cart-footer">
    <div class="cart-subtotal">
      <span>Subtotal:</span>
      <span id="cart-subtotal">$0.00</span>
    </div>
    <button class="checkout-btn" id="checkout-btn" onclick="checkout()" disabled>Proceed to Checkout</button>
  </div>
</div>

<div class="payment-page" id="payment-page">
  <div class="payment-container">
    <div class="payment-header">
      <h1>Complete Your Order</h1>
    </div>
    
    <div class="payment-section">
      <h2>Order Summary</h2>
      <div id="order-items"></div>
      
      <div style="margin-top: 30px;">
        <div class="fee-row subtotal">
          <span>Subtotal</span>
          <span id="payment-subtotal">$0.00</span>
        </div>
        <div class="fee-row">
          <span>GST (15%)</span>
          <span id="gst-fee">$0.00</span>
        </div>
        <div class="fee-row">
          <span>Delivery Fee</span>
          <span>$7.99</span>
        </div>
        <div class="fee-row">
          <span>Service Fee</span>
          <span>$2.99</span>
        </div>
        <div class="fee-row">
          <span>Processing Fee</span>
          <span>$4.50</span>
        </div>
        <div class="fee-row">
          <span>Convenience Fee</span>
          <span>$3.75</span>
        </div>
        <div class="fee-row">
          <span>Handling Fee</span>
          <span>$2.25</span>
        </div>
        <div class="fee-row">
          <span>Environmental Fee</span>
          <span>$1.99</span>
        </div>
        <div class="fee-row">
          <span>Fuel Surcharge</span>
          <span>$5.50</span>
        </div>
        <div class="fee-row">
          <span>Carbon Offset Fee</span>
          <span>$2.10</span>
        </div>
        <div class="fee-row">
          <span>Eco-friendly Packaging Fee</span>
          <span>$1.85</span>
        </div>
        <div class="fee-row">
          <span>Insurance Fee</span>
          <span>$3.99</span>
        </div>
        <div class="fee-row">
          <span>E-Commerce Fee</span>
          <span>$6.99</span>
        </div>
        <div class="fee-row">
          <span>Production Fee</span>
          <span>$8.50</span>
        </div>
        <div class="fee-row">
          <span>Remote Area Delivery Fee</span>
          <span>$12.00</span>
        </div>
        <div class="fee-row total">
          <span>Total</span>
          <span id="payment-total">$0.00</span>
        </div>
      </div>
    </div>
    
    <button class="complete-payment-btn" onclick="completePayment()">Complete Payment</button>
  </div>
</div>

<div class="main-container">
  <div class="product-image-section">
    <img src="https://www.ikea.com/nz/en/images/products/blahaj-soft-toy-shark__0710175_pe727378_s5.jpg" alt="Shark" class="main-shark">
    <div class="placeholder-grid">
      <div class="placeholder-item"><img src="https://m.media-amazon.com/images/I/71hs-euA1xL._AC_SL1000__.jpg" alt="Shark Friend 1"></div>
      <div class="placeholder-item"><img src="https://www.ikea.com/nz/en/images/products/blahaj-soft-toy-baby-shark__0877393_pe730957_s5.jpg" alt="Shark Friend 2"></div>
      <div class="placeholder-item"><img src="https://img.fruugo.com/product/4/63/591572634_max.jpg" alt="Shark Friend 3"></div>
    </div>
  </div>
  
  <div class="product-details">
    <h1>BL√ÖHAJ</h1>
    <h2>Soft toy, shark, 100 cm</h2>
    <div class="price"><span>$</span>39.00</div>
    <button id="main-buy-btn" class="buy-btn" onclick="handleBuyClick()">Add to shopping cart</button>
    <div id="oos-status"></div>
    <p class="shark-desc"><i>is big blue friend. Have much soft and no bone, only stuffing for hug. Do not the shark, just love he.</i></p>
  </div>
</div>

<div id="upsell-container" class="upsell-overlay">
  <div class="upsell-card">
    <span class="close-upsell" onclick="nextUpsell()">√ó</span>
    <h3 id="upsell-title">Don't forget a friend!</h3>
    <img id="upsell-img" src="">
    <p id="upsell-desc">Customers who bought BL√ÖHAJ also loved this!</p>
    <div class="upsell-btns">
      <button class="add-to-cart-btn" onclick="nextUpsell()">Yes, add to bag</button>
    </div>
  </div>
</div>

<div id="page-overlay" onclick="closeCaptcha()"></div>
<div id="captcha-wrapper">
  <div id="recaptcha-anchor-box" onclick="playGifAndContinue()"><img id="anchor-image" src="https://raw.githubusercontent.com/Sevastipol/badui/refs/heads/main/newCaptchaAnchor.png"></div>
  <div id="status-text"></div>
  <div class="captcha-container" id="captcha-main-box">
    <div id="loader-overlay"><div class="spinner"></div><p style="color: #4A90E2; font-weight: bold; margin-top: 10px;">Verifying...</p></div>
    <div class="header"><h2>Select all squares with</h2><h1>BATS</h1></div>
    <div class="grid-wrapper"><div class="grid" id="mainGrid"></div></div>
    <div class="footer"><div class="icons">üîÑ üéß ‚ÑπÔ∏è</div><button class="verify-btn" onclick="checkAnswer()">VERIFY</button></div>
  </div>
</div>

<script>
  let trueBuyAvailable = false; 
  let messageIndex = 0;
  let batIndices = [];
  let isLocked = false;
  let cart = [];
  let upsellsCompleted = false;
  
  const staticAnchor = "https://raw.githubusercontent.com/Sevastipol/badui/refs/heads/main/newCaptchaAnchor.png";
  const animatedGif = "https://mashby.com/wp-content/uploads/2018/01/hero-recaptcha-demo.gif";
  const batGif = "https://gifgifs.com/animations/holidays/halloween/bats_ani.gif";
  const ghostGif = "https://media2.giphy.com/media/v1.Y2lkPTZjMDliOTUyZzVuM2h0dnBib3owMnVpMG1qYjdoZnhtaTB3ZHo2N2lybjFoNDk4cSZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/xhZyIrYIRJbBhTs1nI/200.gif";

  const upsellData = [
    { name: "DJUNGELSKOG Bear", img: "https://www.ikea.com/nz/en/images/products/djungelskog-soft-toy-brown-bear__0710168_pe727370_s5.jpg?f=xl", price: 29.00 },
    { name: "DJUNGELSKOG Snake", img: "https://www.ikea.com/nz/en/images/products/djungelskog-glove-puppet-snake-burmese-python__0710178_pe727381_s5.jpg?f=xl", price: 19.00 },
    { name: "BL√ÖVINGAD Octopus", img: "https://www.ikea.com/nz/en/images/products/blavingad-soft-toy-octopus-yellow__1088894_pe861308_s5.jpg?f=xl", price: 24.00 },
    { name: "√ÖRSTID Table Lamp", img: "https://www.ikea.com/nz/en/images/products/arstid-table-lamp-brass-white__0609329_pe684454_s5.jpg?f=xl", price: 79.00 }
  ];
  let currentUpsellIndex = 0;

  // Shopping Cart Functions
  function updateCartCount() {
    document.getElementById('cart-count').textContent = cart.length;
  }

  function updateCartDisplay() {
    const cartItemsDiv = document.getElementById('cart-items');
    const checkoutBtn = document.getElementById('checkout-btn');
    
    if (cart.length === 0) {
      cartItemsDiv.innerHTML = '<div class="cart-empty">Your cart is empty</div>';
      checkoutBtn.disabled = true;
    } else {
      cartItemsDiv.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
          <img src="${item.img}" alt="${item.name}">
          <div class="cart-item-info">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">$${item.price.toFixed(2)}</div>
          </div>
          <button class="remove-item" onclick="removeFromCart(${index})">Remove</button>
        </div>
      `).join('');
      checkoutBtn.disabled = false;
    }
    
    const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
    document.getElementById('cart-subtotal').textContent = '$' + subtotal.toFixed(2);
  }

  function addToCart(item) {
    cart.push(item);
    updateCartCount();
    updateCartDisplay();
    showNotification(item.name + ' added to cart');
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartCount();
    updateCartDisplay();
  }

  function toggleCart() {
    const sidebar = document.getElementById('cart-sidebar');
    const overlay = document.getElementById('cart-overlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('show');
  }

  function openCart() {
    document.getElementById('cart-sidebar').classList.add('open');
    document.getElementById('cart-overlay').classList.add('show');
  }

  function closeCart() {
    document.getElementById('cart-sidebar').classList.remove('open');
    document.getElementById('cart-overlay').classList.remove('show');
  }

  function checkout() {
    if (cart.length > 0) {
      if (upsellsCompleted) {
        showPaymentPage();
      } else {
        showUpsells();
      }
    }
  }

  function showPaymentPage() {
    const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
    const gst = subtotal * 0.15;
    const extraFees = 7.99 + 2.99 + 4.50 + 3.75 + 2.25 + 1.99 + 5.50 + 2.10 + 1.85 + 3.99 + 6.99 + 8.50 + 12.00;
    const total = subtotal + gst + extraFees;
    
    // Populate order items
    const orderItemsDiv = document.getElementById('order-items');
    orderItemsDiv.innerHTML = cart.map(item => `
      <div class="order-item">
        <span>${item.name}</span>
        <span>$${item.price.toFixed(2)}</span>
      </div>
    `).join('');
    
    document.getElementById('payment-subtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('gst-fee').textContent = '$' + gst.toFixed(2);
    document.getElementById('payment-total').textContent = '$' + total.toFixed(2);
    
    // Close cart before showing payment page
    closeCart();
    document.getElementById('payment-page').style.display = 'block';
  }

  function completePayment() {
    alert('Payment successful! Thank you for your purchase!');
    cart = [];
    updateCartCount();
    updateCartDisplay();
    document.getElementById('payment-page').style.display = 'none';
  }

  function showNotification(text) {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.innerHTML = `
      <span class="check-icon">‚úì</span>
      <span>${text}</span>
    `;
    container.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }

  function handleBuyClick() {
    if (document.getElementById('main-buy-btn').innerText === "OUT OF STOCK") {
      // Do nothing when out of stock
      return;
    } else if (trueBuyAvailable) {
      // Add the shark to cart
      addToCart({ name: "BL√ÖHAJ Shark", img: "https://www.ikea.com/nz/en/images/products/blahaj-soft-toy-shark__0710175_pe727378_s5.jpg", price: 39.00 });
      openCart();
    } else {
      showCaptcha();
    }
  }

  function showUpsells() {
    currentUpsellIndex = 0;
    document.getElementById('upsell-container').style.display = 'flex';
    updateUpsellContent();
  }

  function updateUpsellContent() {
    const item = upsellData[currentUpsellIndex];
    document.getElementById('upsell-title').innerText = `We think you'd love ${item.name}`;
    document.getElementById('upsell-img').src = item.img;
  }

  function nextUpsell() {
    const item = upsellData[currentUpsellIndex];
    addToCart(item);
    
    currentUpsellIndex++;
    if (currentUpsellIndex < upsellData.length) {
      updateUpsellContent();
    } else {
      document.getElementById('upsell-container').style.display = 'none';
      upsellsCompleted = true;
      // Don't automatically show payment page - let user click checkout again
    }
  }

  function showCaptcha() {
    if (!isLocked) {
      document.getElementById('captcha-wrapper').style.display = 'flex';
      document.getElementById('page-overlay').style.display = 'block';
      document.getElementById('recaptcha-anchor-box').style.display = 'block';
      document.getElementById('anchor-image').src = staticAnchor;
      document.getElementById('captcha-main-box').style.display = 'none';
    }
  }

  function closeCaptcha() {
    document.getElementById('captcha-wrapper').style.display = 'none';
    document.getElementById('page-overlay').style.display = 'none';
    isLocked = false;
  }

  function playGifAndContinue() {
    if(isLocked) return;
    isLocked = true;
    document.getElementById('anchor-image').src = animatedGif + "?t=" + new Date().getTime();
    setTimeout(() => {
        document.getElementById('recaptcha-anchor-box').style.display = 'none';
        document.getElementById('captcha-main-box').style.display = 'block';
        buildGrid();
    }, 3600);
  }

  function buildGrid() {
    document.getElementById('loader-overlay').style.display = 'none';
    const g = document.getElementById('mainGrid');
    g.innerHTML = '';
    batIndices = [];
    for (let i = 0; i < 9; i++) {
      const isBat = Math.random() > 0.4; 
      if (isBat) batIndices.push(i);
      const tile = document.createElement('div');
      tile.className = 'tile';
      if (isBat) {
        const bat = document.createElement('img');
        bat.src = batGif; bat.className = 'flying-bat';
        bat.style.animationDelay = (Math.random() * 2) + "s";
        bat.onclick = (e) => { e.stopPropagation(); tile.classList.toggle('selected'); };
        tile.appendChild(bat);
      } else {
        const ghost = document.createElement('img');
        ghost.src = ghostGif; ghost.className = 'ghost-decoy';
        ghost.onclick = () => tile.classList.toggle('selected');
        tile.appendChild(ghost);
      }
      g.appendChild(tile);
    }
  }

  function checkAnswer() {
    document.getElementById('loader-overlay').style.display = 'flex';
    setTimeout(() => {
      const tiles = document.querySelectorAll('.tile');
      let isCorrect = true;
      tiles.forEach((tile, index) => {
        if (tile.classList.contains('selected') !== batIndices.includes(index)) isCorrect = false;
      });
      if (isCorrect && batIndices.length > 0) {
        document.getElementById('loader-overlay').style.display = 'none';
        document.getElementById('status-text').innerText = "Sorry, something went wrong. Please try again later.";
        setTimeout(() => {
            document.getElementById('main-buy-btn').innerText = "OUT OF STOCK";
            document.getElementById('main-buy-btn').style.backgroundColor = "#888";
            closeCaptcha();
            // Restore stock after 3.2 seconds
            setTimeout(() => {
              document.getElementById('main-buy-btn').innerText = "Add to shopping cart";
              document.getElementById('main-buy-btn').style.backgroundColor = "#0058a3";
              document.getElementById('oos-status').innerText = "";
              trueBuyAvailable = true;
            }, 3200);
        }, 3000);
      } else {
        document.getElementById('loader-overlay').style.display = 'none';
        document.getElementById('status-text').innerText = "Please try again.";
        setTimeout(() => {
            document.getElementById('status-text').innerText = "";
        }, 3000);
        buildGrid();
      }
    }, 1500);
  }
</script>

</body>
</html>
